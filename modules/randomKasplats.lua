KasplatLocations = {
	[0] = { -- Japes
	--  [number] = {map, {x, y, z}, chunk, spoilerName},
		[1] = {7, {870, 280, 3578}, 12, "Behind Rambi Wall"},-- Behind Rambi Wall
		[2] = {7, {1592, 989, 2443}, 3, "On top of mountain"},-- On top of mountain
		[3] = {7, {2270, 552, 3153}, 7, "Beehive Area"},-- Beehive Area
		[4] = {7, {2769, 335, 2071}, 4, "Lower area of Tunnel to Beehive"},-- Lower tunnel to Beehive
		[5] = {7, {3180, 437, 2379}, 5, "Upper area of Tunnel to Beehive"},-- Upper tunnel to Beehive
		[6] = {33, {427, 20, 456}, 1, "Underground"},-- Underground
		[7] = {7, {2014, 251, 2767}, 16, "Near Speedy Swing Sortie Bonus"},-- Near SSSortie
		[8] = {7, {884, 280, 2578}, 9, "Near Painting Room"},-- Near Painting Room
		[9] = {7, {1333, 280 ,1938}, 3, "Inside Tiny's Cage"}, -- Tiny Cage GB
		[10] = {7, {899, 280, 640}, 0, "Starting Area"}, -- First Area
		[11] = {7, {2461, 280, 548}, 2, "Diddy Cave"}, -- Diddy Cave
		[12] = {7, {1569, 160, 1844}, 3, "In the river"}, -- In the river
		[13] = {7, {382, 140, 2818}, 13, "In the water near Rambi Wall"}, -- In the water at the fairy
		[14] = {7, {1675, 280, 4197}, 14, "Near Cranky's"}, -- Cranky Area
		[15] = {7, {773, 538, 2320}, 3, "In the T&S Alcove"}, -- In the T&S alcove (with the DK bunch)
	},
	[1] = { -- Aztec
		[1] = {38, {2738, 120, 4763}, 11, "In the Stealthy Snoop Tunnel"},-- In Stealthy Snoop Tunnel
		[2] = {38, {2467, 116, 990}, 4, "On the Oasis"},-- Oasis
		[3] = {38, {2129, 312, 1551}, 4, "On the Llama's Cage"},-- On Llama Cage
		[4] = {38, {3782, 120, 2391}, 8, "Near the giant boulder"},-- Tunnel (near big boulder)
		[5] = {38, {1363, 162, 738}, 3, "Behind the DK Stone Door"},-- Behind DK Stone Door
		[6] = {20, {1378, 420, 3632}, 6, "In the lava room in Llama Temple"},-- In Llama Temple
		[7] = {38, {3162, 120, 1845}, 6, "Near the Hunky Chunky Barrel"},-- Tunnel (near Chunky Barrel)
		[8] = {38, {3301, 97, 3776}, 12, "Base of the Totem"}, -- Base of Totem
		[9] = {38, {280, 138, 716}, 1, "In the Vase Room"}, -- in the Chunky vase room
		[10] = {38, {1997, 280, 3500}, 12, "Behind the 5-Door Temple"}, -- alcove in the back of 5DT
		[11] = {38, {3969, 190, 4037}, 12, "Near Snide's"}, -- near Snide's
		[12] = {20, {1964, 472, 2408}, 0, "Below the Llama in Llama Temple"}, -- In Llama temple, next to the llama (down)
		[13] = {16, {453, 345, 1465}, 4, "In the Free Tiny Room"}, -- OKONG Room
	},
	[2] = { -- Factory
		[1] = {26, {1591, 1113, 615}, 18, "Near Funky's"},-- By Funky's
		[2] = {26, {1712, 837, 2389}, 12, "Starting Area"},-- Lobby
		[3] = {26, {1464, 127, 865}, 0, "Near the Power Hut"},-- Power Hut Platform
		[4] = {26, {646, 460, 1792}, 7, "Down the pole covered by a Hatch"},-- Middle Floor of Hatch Pole
		[5] = {26, {2053, 7, 573}, 1, "In the Dark Room"},-- Dark Room
		[6] = {26, {633, 157, 1672}, 5, "On the lowest platform in Production Room"},-- Lowest platform of Prod Room
		[7]	= {26, {782, 557, 1686}, 5, "Near the slippery pipe in Production Room"},-- Near Lanky Pipe
		[8] = {26, {509, 0, 1591}, 5, "At the base of Production Room"},-- Lower Production Room
		[9] = {26, {4148, 1336, 1016}, 23, "In Research & Development"},-- In R&D
		[10] = {26, {1296, 6, 240}, 2, "Below the pole to the DK Arcade Machine"},-- Below pole to Arcade
		[11] = {26, {2234, 1026, 1372}, 16, "In Block Tower Room"},-- Block Tower Room
		[12] = {26, {2664, 1034, 1834}, 8, "On the 1-16 Number Game"},-- Number game
		[13] = {26, {621, 440, 1335}, 7, "Inside the central Crusher in Production Room"},-- Inside the Crusher
		[14] = {26, {1276, 201, 710}, 0, "On Chunky's Cage"}, -- On Chunky's Cage
		[15] = {26, {1579, 811, 2197}, 10, "Near Snide's"}, -- Snide's
	},
	[3] = { -- Galleon
		[1] = {30, {3468, 1670, 3803}, 8, "Near the 3 Above-Ground treasure Chests"},-- Chest area
		[2] = {30, {1631, 1611, 4162}, 9, "On the Lighthouse island"},-- Lighthouse Platform
		[3] = {30, {3596, 1614, 1899}, 13, "Near Warp 5 on the 5-Door Ship Side"},-- Floating Platform
		[4] = {30, {1885, 942, 3872}, 9, "Near the Enguarde Box on Lighthouse Side"},-- Near Enguarde Box
		[5] = {30, {2037, 1750, 769}, 17, "On Diddy's Gold Tower"},-- Gold Tower
		[6] = {30, {699, 1564, 4093}, 9, "In the Alcove near the Lighthouse"},-- Near Chunky Instrument Pad
		[7] = {30, {1308, 1610, 2794}, 5, "On the platforms in Cannon Game Room"},-- Cannon Game Room
		[8] = {30, {2806, 1890, 2969}, 6, "Near the T&S near Cranky's"},-- Near Cranky T&S
		[9] = {30, {4372, 1650, 1031}, 13, "On the Cactus near the sunken submarine"},-- Cactus
		[10] = {30, {3307, 1680, 2451}, 7, "On the Crown Pad"}, -- Crown
		[11] = {30, {1249, 1451, 2876}, 5, "In the water in Cannon Game Room"}, -- In the cannon room water
		[12] = {30, {3314, 1792, 2498}, 7, "Next to Cranky's"}, -- on Cranky's platform
		[13] = {30, {2547, 1173, 2000}, 12, "On the 5-Door Ship"}, -- On 5DS
		--[14] = {}, -- *On* K Rool's Ship
	},
	[4] = { -- Fungi
		[1] = {48, {4672, 153, 4130}, 2, "By the tag barrel near the exit to the Minecart"},-- New Rainbow Coin
		[2] = {48, {3150, 273, 4332}, 4, "Behind the Diddy Dark Barn"},-- Behind Diddy Barn
		[3] = {48, {1853, 230, 473}, 9, "Behind the beanstalk"},-- Beanstalk
		[4] = {48, {183, 241, 756}, 11, "Near the rocketbarrel near the Giant Mushroom"},-- Near GM Rocketbarrel
		[5] = {48, {647, 1250, 633}, 11, "At the top of the Giant Mushroom"},-- GM High Tag
		[6] = {48, {1346, 291, 4594}, 16, "Near the Anthill"},-- Near Anthill
		[7] = {48, {2335, 143, 3639}, 15, "Near the sleeping Rabbit"},-- Near Rabbit Race
		[8] = {48, {543, 194, 3748}, 17, "Near the T&S near the Owl's Tree"},-- Near Tree T&S
		[9] = {48, {3693, 115, 1546}, 5, "Behind DK's Barn"},-- Behind DK Barn
		[10] = {64, {329, 534, 402}, 0, "Inside the Giant Mushroom"},-- In Giant Mushroom
		[11] = {48, {1270, 249, 3927}, 14, "Under the Owl's Tree"},-- Under the Tree
		[12] = {48, {1290, 389, 678}, 11, "On a low platform on the exterior of Giant Mushroom"},-- Lower platform (GM Exterior)
		[13] = {48, {732, 979, 597}, 11, "On a high platform on the exterior of Giant Mushroom"},-- Upper platform (GM Exterior)
		[14] = {48, {2297, 604, 2318}, 0, "Behind the Cuckoo Clock"}, -- Clock
		[15] = {61, {360, 0, 450}, 0, "Inside the mill"}, -- Mill
		[16] = {48, {1009, 100, 576}, 11, "In the moat around the Giant Mushroom"}, -- Moat (GM Exterior)
	},
	[5] = { -- Caves
		[1] = {72, {2594, 14, 434}, 0, "In the room near the start"},-- GGone Room
		[2] = {72, {1242, 65, 585}, 2, "Near Snide's"},-- Snide's Room
		[3] = {72, {523, 181, 2498}, 6, "In the room with Tiny's Bonus Barrel"},-- W3 Room
		[4] = {72, {752, 53, 778}, 8, "Inside an Ice Shield"},-- Inside Chunky Ice Shield
		[5] = {72, {3645, 343, 1865}, 4, "On the Cabin with 5 Doors"},-- 5DC Exterior
		[6] = {72, {2648, 173, 1770}, 4, "Near the headphones near Lanky's Cabin"},-- Meme area near 1DC Headphones
		[7] = {72, {1915, 280, 2676}, 7, "In the room with the Giant Boulder"},-- Giant Boulder Room
		[8] = {72, {1705, 285, 745}, 11, "Near the Ice Castle"},-- Above Snide's Room
		[9] = {72, {3517, 286, 767}, 3, "In the Hidden Room by Funky's"},-- Hidden W4 Room
		[10] = {72, {2783, 366, 927}, 9, "On the platform near Funky's"},-- W5 Platform
		[11] = {72, {2911, 379, 1858}, 4, "By the Far Warp 2"},-- Near Rotating Room
		[12] = {72, {577, 142, 1285}, 8, "On the 5-Door Igloo"},-- On 5DI
		[13] = {72, {1340, 14, 2047}, 5, "In the water by the Baboon Blast Pad"}, -- In the river near Pillar W4
		[14] = {72, {2434, 99, 1209}, 9, "Inbetween Funky's and the Ice Castle"}, -- left side of river, near the edge where you jump across to climb to Funky's
	},
	[6] = { -- Castle
		[1] = {183, {439, 90, 1242}, 3, "In the Crypt, to the left"},-- Crypt near D/D/C Entrance
		[2] = {183, {1839, 320, 1278}, 2, "In the Crypt, to the right"},-- Crypt near L/T Entrance
		[3] = {163, {526, 195, 2013}, 1, "Inside the dungeon"},-- Dungeon
		[4] = {87, {1655, 371, 2048}, 0, "Near the T&S at the back of Castle"},-- Near exterior lower T&S
		[5] = {88, {547, 45, 613}, 2, "Inside the Ballroom"},-- Ballroom
		[6] = {87, {1388, 1732, 1353}, 4, "At the top of the Castle"},-- Top of Castle
		[7] = {164, {937, 400, 1424}, 2, "Inside the Tree"},-- In Tree
		[8] = {183, {1112, 200, 1242}, 1, "In the Crypt, straight ahead"},-- Crypt (central path)
		[9] = {87, {1892, 904, 1626}, 1, "Near the upper Warp 2"},-- Near upper W2
		[10] = {87, {66, 392, 911}, 0, "Near the Crypt Entrance on a lone platform"},-- Past Crypt (Exterior)
		[11] = {151, {536, 220, 2205}, 1, "Near Candy's"},-- In Dungeon Tunnel
		[12] = {87, {845, 330, 235}, 0, "In the water near the Tree"}, -- In the water by the drain pipe exit
		[13] = {87, {385, 1140, 1389}, 2, "Near Cranky's Hut"}, -- by Cranky's hut
		[14] = {87, {195, 623, 542}, 0, "Near the Rocketbarrel by the drawbridge"}, -- near the lower diddy RB
		[15] = {199, {740, 310, 630}, 0, "Inside the King Kutout Boss Fight"}, -- King Kut Out Boss Fight
	},
	[7] = { -- Isles
		[1] = {169, {598, 0, 576}, 0, "Inside Jungle Japes Lobby"},-- Japes Lobby
		[2] = {34, {3557, 497, 1555}, 0, "On the Beaver Beach"},-- Beaver Beach
		[3] = {175, {676, 134, 372}, 0, "Inside Factory Lobby, above the DK Portal"},-- Factory Lobby (upper platform)
		[4] = {173, {1007, 0, 491}, 1, "Inside Aztec Lobby, behind Tiny's Switch Door"},-- Aztec Lobby (behind Tiny Switch door)
		[5] = {170, {335, 191, 637}, 0, "Inside Hideout Helm Lobby"},-- Helm Lobby
		[6] = {193, {577, 71, 766}, 0, "Inside Creepy Castle Lobby"},-- Castle Lobby
		[7] = {194, {1674, 13, 685}, 1, "Inside Crystal Caves Lobby"},-- Caves Lobby
		[8] = {175, {245, 81, 150}, 0, "Inside Factory Lobby, in the ? Box"},-- Factory Lobby (In ? Box)
		[9] = {174, {762, 119, 900}, 0, "Inside Gloomy Galleon Lobby"},-- Galleon Lobby
		[10] = {34, {4449, 552, 1673}, 0, "Inside the Rock which is blown up"}, -- Big X Rock
		[11] = {34, {2357, 1199, 3903}, 1, "At the back of Kroc Isle, halfway up"}, -- at the back of the W4 platform
		[12] = {34, {1578, 499, 457}, 0, "On the Big X Platform"}, -- Big X
		[13] = {34, {2449, 1498, 785}, 0, "Behind the house to Fungi Lobby"}, -- behind Fungi lobby
		[14] = {171, {361, 85, 488}, 0, "Inside DK's House"}, -- In DK's House
		--[15] = {}, -- Inside K Rool's Crown
	},
};

potential_enemies_table = {
	[1] = 0x0, -- Beaver
	[2] = 0x3B, -- Kremling
	[3] = 0x5, -- Zinger (Not Charger)
	[4] = 0x1C, -- Zinger (Charger)
	[5] = 0x67, -- Kosha
	[6] = 0x54, -- Krossbones
	[7] = 0x66, -- Pufftup
	[8] = 0x53, -- Robo-Zinger
	[9] = 0x50, -- Cutscene Object
};
 
function generateKasplatAssortment()
	kasplat_assortment = {};
	for i = 0, 7 do
		temporary_kasplat_assortment = {};
		kasplat_assortment[i] = {};
		kasplat_seedSetting = (seedAsNumber * 100000 * (i + 1));
		for j = 1, #KasplatLocations[i] do
			temporary_kasplat_assortment[j] = j;
		end
		math.randomseed(kasplat_seedSetting);
		for k = 1, 5 do -- 5 Kongs
			selected_temp_value = math.ceil(math.random() * #temporary_kasplat_assortment);
			kasplat_assortment[i][k] = temporary_kasplat_assortment[selected_temp_value];
			table.remove(temporary_kasplat_assortment, selected_temp_value);
		end
	end
end

generateKasplatAssortment();

function replaceKasplats()
	current_cmap = mainmemory.read_u32_be(Mem.cmap[version]);
	if mapType(current_cmap) ~= "crown_maps" then
		for i = 1, 5 do
			kasplatTable = {}
			kasplatTable[1] = 0x3C + i;
			kasplats_kong = getEnemyPointerFromIds(kasplatTable);
			if #kasplats_kong > 0 then
				mainmemory.writebyte(kasplats_kong[1],0);
			end
		end
	end
end

function getKasplatCount(level)
	current_cmap = mainmemory.read_u32_be(Mem.cmap[version]);
	kasplat_count = 0;
	kasplats_in_map = {};
	if mapType(current_cmap) ~= "crown_maps" then
		for i = 1, 5 do
			value_to_check = kasplat_assortment[level][i];
			if current_cmap == KasplatLocations[level][value_to_check][1] then
				kasplat_count = kasplat_count + 1;
				kasplats_in_map[kasplat_count] = i;
			end
		end
	end
	return kasplat_count;
end

function writeKasplats(level)
	current_cmap = mainmemory.read_u32_be(Mem.cmap[version]);
	beavers_in_map = getEnemyPointerFromIds(potential_enemies_table);
	if mapType(current_cmap) ~= "crown_maps" then
		for i = 1, #kasplats_in_map do
			kong = kasplats_in_map[i];
			value_to_check = kasplat_assortment[level][kong];
			number_in_array = i;
			if #beavers_in_map > 0 then
				for k = 1, #beavers_in_map do
					if mainmemory.read_s16_be(beavers_in_map[k] + 4) == KasplatLocations[level][value_to_check][2][1] then
						if mainmemory.read_s16_be(beavers_in_map[k] + 6) == KasplatLocations[level][value_to_check][2][2] then
							if mainmemory.read_s16_be(beavers_in_map[k] + 8) == KasplatLocations[level][value_to_check][2][3] then
								number_in_array = k;
							end
						end
					end
				end
			end
			mainmemory.writebyte(beavers_in_map[number_in_array],0x3C + kong); -- Set Enemy Value
			for j = 1, 3 do
				mainmemory.write_s16_be(beavers_in_map[number_in_array] + 2 + (2 * j), KasplatLocations[level][value_to_check][2][j]); -- X/Y/Z
			end
			mainmemory.writebyte(beavers_in_map[number_in_array] + 0xF, 50); -- Scale
			mainmemory.write_s16_be(beavers_in_map[number_in_array] + 0x40, KasplatLocations[level][value_to_check][3]); -- Chunk
		end
	end
end

kasplat_rando_happened = 0;

lobbies = {
	[0] = 169, -- Japes
	[1] = 173, -- Aztec
	[2] = 175, -- Factory
	[3] = 174, -- Galleon
	[4] = 178, -- Fungi
	[5] = 194, -- Caves
	[6] = 193, -- Castle
	[7] = 217, -- Isles (Value doesn't exist, so gets unused. Value is set to prevent exception error)
	[8] = 170, -- Helm
};

levels = {
	[0] = "JAPES",
	[1] = "AZTEC",
	[2] = "FACTORY",
	[3] = "GALLEON",
	[4] = "FUNGI",
	[5] = "CAVES",
	[6] = "CASTLE",
	[7] = "DK ISLES",
};

kongs = {
	[1] = "DK",
	[2] = "Diddy",
	[3] = "Lanky",
	[4] = "Tiny",
	[5] = "Chunky",
};

function writeData()
	current_cmap = mainmemory.read_u32_be(Mem.cmap[version]);
	transition_speed_value = mainmemory.readfloat(Mem.transition_speed[version], true);
	obj_m2_timer_value = mainmemory.read_u32_be(Mem.obj_model2_timer[version]);
	levelIndexKasplats = mainmemory.readbyte(Mem.level_index_mapping[version] + current_cmap);
	for i = 0, 8 do
		if lobbies[i] == current_cmap then
			levelIndexKasplats = 7;
		end
	end
	if transition_speed_value < 0 and obj_m2_timer_value == 1 and kasplat_rando_happened == 0 then
		if levelIndexKasplats < 8 then
			replaceKasplats();
			getKasplatCount(levelIndexKasplats);
			writeKasplats(levelIndexKasplats);
			print("Kasplats Inserted");
			kasplat_rando_happened = 1;
		end
	elseif transition_speed_value > 0 then
		kasplat_rando_happened = 0;
	end
end

function displayKasplatSpoiler()
	print("");
	print("~~~~~~~~~~~~~~");
	print("Seed: "..seedAsNumber);
	for i = 0, 7 do
		print("");
		print(levels[i]);
		for j = 1, 5 do
			value_to_check = kasplat_assortment[i][j];
			print(kongs[j]..": "..KasplatLocations[i][value_to_check][4]);
		end
	end
end

event.onframeend(writeData, "Randomises Kasplat Location");